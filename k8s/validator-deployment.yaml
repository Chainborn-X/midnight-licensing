---
# Namespace for Chainborn Licensing components
apiVersion: v1
kind: Namespace
metadata:
  name: chainborn
  labels:
    name: chainborn

---
# PersistentVolumeClaim for validator cache
# Provides persistent storage for validation results across pod restarts
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: validator-cache-pvc
  namespace: chainborn
  labels:
    app: validator
    component: cache
spec:
  accessModes:
    - ReadWriteMany  # Allows multiple pods to share cache (use ReadWriteOnce for single pod)
  storageClassName: standard  # Update to match your cluster's storage class
  resources:
    requests:
      storage: 10Gi

---
# ConfigMap for license policies
# Store policy JSON files as configuration data
apiVersion: v1
kind: ConfigMap
metadata:
  name: validator-policies
  namespace: chainborn
  labels:
    app: validator
    component: policies
data:
  # Add your policy files here, or create from files using:
  # kubectl create configmap validator-policies --from-file=policies/ -n chainborn
  # Example policy (replace with actual policy files):
  example-product.json: |
    {
      "productId": "example-product",
      "minimumTier": "standard",
      "cacheTTL": "01:00:00",
      "bindingMode": "device"
    }

---
# Deployment for validator service
# Runs the Chainborn validator with persistent cache
apiVersion: apps/v1
kind: Deployment
metadata:
  name: validator
  namespace: chainborn
  labels:
    app: validator
spec:
  replicas: 3  # Adjust based on load requirements
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: validator
  template:
    metadata:
      labels:
        app: validator
    spec:
      securityContext:
        fsGroup: 1654  # Set group ownership for mounted volumes
      containers:
        - name: validator
          image: chainborn/validator:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
            - name: Licensing__CacheDirectory
              value: "/var/chainborn/cache"
            - name: Licensing__PolicyDirectory
              value: "/etc/chainborn/policies"
          volumeMounts:
            - name: cache-volume
              mountPath: /var/chainborn/cache
            - name: policy-volume
              mountPath: /etc/chainborn/policies
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          securityContext:
            runAsUser: 1654
            runAsGroup: 1654
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            # Set to true if cache uses external storage
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: cache-volume
          persistentVolumeClaim:
            claimName: validator-cache-pvc
        - name: policy-volume
          configMap:
            name: validator-policies

---
# Service to expose validator pods
apiVersion: v1
kind: Service
metadata:
  name: validator-service
  namespace: chainborn
  labels:
    app: validator
spec:
  type: ClusterIP  # Change to LoadBalancer for external access
  selector:
    app: validator
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8080
  sessionAffinity: None

---
# Optional: HorizontalPodAutoscaler for auto-scaling based on CPU
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: validator-hpa
  namespace: chainborn
  labels:
    app: validator
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: validator
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
